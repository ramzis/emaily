!function(e){var t={};function n(r){if(t[r])return t[r].exports;var o=t[r]={i:r,l:!1,exports:{}};return e[r].call(o.exports,o,o.exports,n),o.l=!0,o.exports}n.m=e,n.c=t,n.d=function(e,t,r){n.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:r})},n.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},n.t=function(e,t){if(1&t&&(e=n(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var r=Object.create(null);if(n.r(r),Object.defineProperty(r,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var o in e)n.d(r,o,function(t){return e[t]}.bind(null,o));return r},n.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return n.d(t,"a",t),t},n.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},n.p="/",n(n.s=8)}([function(e,t){e.exports=require("mongoose")},function(e,t){e.exports=require("passport")},function(e,t,n){e.exports=n(10)},function(e,t){e.exports=require("express")},function(e,t){e.exports=require("cookie-session")},function(e,t){e.exports=require("body-parser")},function(e,t){e.exports=require("stripe")},function(e,t){e.exports=require("passport-google-oauth20")},function(e,t,n){n(9),e.exports=n(12)},function(e,t){e.exports=require("@babel/polyfill")},function(e,t,n){"use strict";n.r(t),t.default={googleClientID:process.env.GOOGLE_CLIENT_ID,googleClientSecret:process.env.GOOGLE_CLIENT_SECRET,mongoURI:process.env.MONGO_URI,cookieKey:process.env.COOKIE_KEY,stripePublishableKey:process.env.STRIPE_PUBLISHABLE_KEY,stripeSecretKey:process.env.STRIPE_SECRET_KEY,sendGridKey:process.env.SEND_GRID_KEY}},function(e,t){e.exports=require("path")},function(e,t,n){"use strict";n.r(t);var r=n(3),o=n.n(r),i=n(0),u=n.n(i),s=n(4),a=n.n(s),c=n(1),l=n.n(c),f=n(5),p=n.n(f),d=n(2),g=n.n(d),v=function(e){e.get("/auth/google",l.a.authenticate("google",{scope:["profile","email"]})),e.get("/auth/google/callback",l.a.authenticate("google"),function(e,t){t.redirect("/surveys")}),e.get("/api/logout",function(e,t){e.logout(),t.redirect("/")}),e.get("/api/current_user",function(e,t){t.send(e.user)})},y=n(6),m=function(e,t,n){if(!e.user)return t.status(401).send({error:"You must log in!"});n()};function b(e,t,n,r,o,i,u){try{var s=e[i](u),a=s.value}catch(e){return void n(e)}s.done?t(a):Promise.resolve(a).then(r,o)}var h=n.n(y)()(g.a.stripeSecretKey),x=function(e){e.post("/api/stripe",m,(t=regeneratorRuntime.mark(function e(t,n){var r;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,h.charges.create({amount:500,currency:"usd",description:"$5 for 5 credits",source:t.body.id});case 2:return e.sent,t.user.credits+=5,e.next=6,t.user.save();case 6:r=e.sent,n.send(r);case 8:case"end":return e.stop()}},e)}),n=function(){var e=this,n=arguments;return new Promise(function(r,o){var i=t.apply(e,n);function u(e){b(i,r,o,u,s,"next",e)}function s(e){b(i,r,o,u,s,"throw",e)}u(void 0)})},function(e,t){return n.apply(this,arguments)}));var t,n},S=function(e,t,n){if(e.user.credits<1)return t.status(403).send({error:"Not enough credits!"});n()},_=u.a.model("surveys"),I=function(e){e.post("/api/surveys",m,S,function(e,t){var n=e.body,r=n.title,o=n.subject,i=n.body,u=n.recipients;new _({title:r,subject:o,body:i,recipients:u.split(",").map(function(e){return{email:e.trim()}}),_user:e.user.id,dateSent:Date.now()})})},O=new i.Schema({googleId:String,credits:{type:Number,default:0}});u.a.model("users",O);var w=new i.Schema({email:String,responded:{type:Boolean,default:!1}}),E=new i.Schema({title:String,body:String,subject:String,recipients:[w],yes:{type:Number,default:0},no:{type:Number,default:0},_user:{type:i.Schema.Types.ObjectId,ref:"User"},dateSent:Date,lastResponded:Date});u.a.model("surveys",E);var P=n(7);function R(e,t,n,r,o,i,u){try{var s=e[i](u),a=s.value}catch(e){return void n(e)}s.done?t(a):Promise.resolve(a).then(r,o)}var j=u.a.model("users");l.a.serializeUser(function(e,t){t(null,e.id)}),l.a.deserializeUser(function(e,t){j.findById(e).then(function(e){t(null,e)})});l.a.use(new P.Strategy({clientID:g.a.googleClientID,clientSecret:g.a.googleClientSecret,callbackURL:"/auth/google/callback",proxy:!0},function(){var e,t=(e=regeneratorRuntime.mark(function e(t,n,r,o){var i;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,j.findOne({googleID:r.id});case 2:if(i=e.sent){e.next=7;break}return e.next=6,new j({googleID:r.id}).save();case 6:i=e.sent;case 7:o(null,i);case 8:case"end":return e.stop()}},e)}),function(){var t=this,n=arguments;return new Promise(function(r,o){var i=e.apply(t,n);function u(e){R(i,r,o,u,s,"next",e)}function s(e){R(i,r,o,u,s,"throw",e)}u(void 0)})});return function(e,n,r,o){return t.apply(this,arguments)}}()));u.a.connect(g.a.mongoURI,{useNewUrlParser:!0},function(e){e&&console.log(e)});var D=o()();D.use(p.a.json()),D.use(a()({maxAge:2592e6,keys:[g.a.cookieKey]})),D.use(l.a.initialize()),D.use(l.a.session()),v(D),x(D),I(D);var K=n(11).join(__dirname,"../client","build");D.use(o.a.static(K)),D.get("*",function(e,t){t.sendFile("index.html",{root:K})});var k=process.env.PORT||5e3;D.listen(k)}]);