!function(e){var n={};function t(r){if(n[r])return n[r].exports;var o=n[r]={i:r,l:!1,exports:{}};return e[r].call(o.exports,o,o.exports,t),o.l=!0,o.exports}t.m=e,t.c=n,t.d=function(e,n,r){t.o(e,n)||Object.defineProperty(e,n,{enumerable:!0,get:r})},t.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},t.t=function(e,n){if(1&n&&(e=t(e)),8&n)return e;if(4&n&&"object"==typeof e&&e&&e.__esModule)return e;var r=Object.create(null);if(t.r(r),Object.defineProperty(r,"default",{enumerable:!0,value:e}),2&n&&"string"!=typeof e)for(var o in e)t.d(r,o,function(n){return e[n]}.bind(null,o));return r},t.n=function(e){var n=e&&e.__esModule?function(){return e.default}:function(){return e};return t.d(n,"a",n),n},t.o=function(e,n){return Object.prototype.hasOwnProperty.call(e,n)},t.p="/",t(t.s=9)}([function(e,n){e.exports=require("mongoose")},function(e,n,t){e.exports=t(11)},function(e,n){e.exports=require("passport")},function(e,n){e.exports=require("sendgrid")},function(e,n){e.exports=require("express")},function(e,n){e.exports=require("cookie-session")},function(e,n){e.exports=require("body-parser")},function(e,n){e.exports=require("passport-google-oauth20")},function(e,n){e.exports=require("stripe")},function(e,n,t){t(10),e.exports=t(13)},function(e,n){e.exports=require("@babel/polyfill")},function(e,n,t){"use strict";t.r(n),n.default={googleClientID:process.env.GOOGLE_CLIENT_ID,googleClientSecret:process.env.GOOGLE_CLIENT_SECRET,mongoURI:process.env.MONGO_URI,cookieKey:process.env.COOKIE_KEY,stripePublishableKey:process.env.STRIPE_PUBLISHABLE_KEY,stripeSecretKey:process.env.STRIPE_SECRET_KEY,sendGridKey:process.env.SEND_GRID_KEY,redirectDomain:process.env.REDIRECT_DOMAIN}},function(e,n){e.exports=require("path")},function(e,n,t){"use strict";t.r(n);var r=t(4),o=t.n(r),i=t(0),u=t.n(i),a=t(5),s=t.n(a),c=t(2),l=t.n(c),f=t(6),p=t.n(f),d=t(1),v=t.n(d),y=new i.Schema({googleId:String,credits:{type:Number,default:0}});u.a.model("users",y);var m=new i.Schema({email:String,responded:{type:Boolean,default:!1}}),g=new i.Schema({title:String,body:String,subject:String,recipients:[m],yes:{type:Number,default:0},no:{type:Number,default:0},_user:{type:i.Schema.Types.ObjectId,ref:"User"},dateSent:Date,lastResponded:Date});u.a.model("surveys",g);var h=t(7);function b(e,n,t,r,o,i,u){try{var a=e[i](u),s=a.value}catch(e){return void t(e)}a.done?n(s):Promise.resolve(s).then(r,o)}var w=u.a.model("users");l.a.serializeUser(function(e,n){n(null,e.id)}),l.a.deserializeUser(function(e,n){w.findById(e).then(function(e){n(null,e)})});l.a.use(new h.Strategy({clientID:v.a.googleClientID,clientSecret:v.a.googleClientSecret,callbackURL:"/auth/google/callback",proxy:!0},function(){var e,n=(e=regeneratorRuntime.mark(function e(n,t,r,o){var i,u;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,w.findOne({googleId:r.id});case 2:if(!(i=e.sent)){e.next=5;break}return e.abrupt("return",o(null,i));case 5:return e.next=7,new w({googleId:r.id}).save();case 7:u=e.sent,o(null,u);case 9:case"end":return e.stop()}},e)}),function(){var n=this,t=arguments;return new Promise(function(r,o){var i=e.apply(n,t);function u(e){b(i,r,o,u,a,"next",e)}function a(e){b(i,r,o,u,a,"throw",e)}u(void 0)})});return function(e,t,r,o){return n.apply(this,arguments)}}()));var x=function(e){e.get("/auth/google",l.a.authenticate("google",{scope:["profile","email"]})),e.get("/auth/google/callback",l.a.authenticate("google"),function(e,n){n.redirect("/surveys")}),e.get("/api/logout",function(e,n){e.logout(),n.redirect("/")}),e.get("/api/current_user",function(e,n){n.send(e.user)})},S=t(8),k=function(e,n,t){if(!e.user)return n.status(401).send({error:"You must log in!"});t()};function _(e,n,t,r,o,i,u){try{var a=e[i](u),s=a.value}catch(e){return void t(e)}a.done?n(s):Promise.resolve(s).then(r,o)}var O=t.n(S)()(v.a.stripeSecretKey),P=function(e){e.post("/api/stripe",k,(n=regeneratorRuntime.mark(function e(n,t){var r;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,O.charges.create({amount:500,currency:"usd",description:"$5 for 5 credits",source:n.body.id});case 2:return e.sent,n.user.credits+=5,e.next=6,n.user.save();case 6:r=e.sent,t.send(r);case 8:case"end":return e.stop()}},e)}),t=function(){var e=this,t=arguments;return new Promise(function(r,o){var i=n.apply(e,t);function u(e){_(i,r,o,u,a,"next",e)}function a(e){_(i,r,o,u,a,"throw",e)}u(void 0)})},function(e,n){return t.apply(this,arguments)}));var n,t},E=function(e,n,t){if(e.user.credits<1)return n.status(403).send({error:"Not enough credits!"});t()},R=t(3),I=t.n(R);function j(e){return(j="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function T(e,n,t,r,o,i,u){try{var a=e[i](u),s=a.value}catch(e){return void t(e)}a.done?n(s):Promise.resolve(s).then(r,o)}function C(e,n){for(var t=0;t<n.length;t++){var r=n[t];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function D(e,n){return!n||"object"!==j(n)&&"function"!=typeof n?function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e):n}function q(e){return(q=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function K(e,n){return(K=Object.setPrototypeOf||function(e,n){return e.__proto__=n,e})(e,n)}var N=function(e){function n(e,t){var r,o=e.subject,i=e.recipients;return function(e,n){if(!(e instanceof n))throw new TypeError("Cannot call a class as a function")}(this,n),(r=D(this,q(n).call(this))).sgApi=I()(v.a.sendGridKey),r.from_email=new R.mail.Email("no-reply@emaily.com"),r.subject=o,r.body=new R.mail.Content("text/html",t),r.recipients=r.formatAddresses(i),r.addContent(r.body),r.addClickTracking(),r.addRecipients(),r}var t,r,o;return function(e,n){if("function"!=typeof n&&null!==n)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(n&&n.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),n&&K(e,n)}(n,R["mail"].Mail),t=n,(r=[{key:"formatAddresses",value:function(e){return e.map(function(e){var n=e.email;return new R.mail.Email(n)})}},{key:"addClickTracking",value:function(){var e=new R.mail.TrackingSettings,n=new R.mail.ClickTracking(!0,!0);e.setClickTracking(n),this.addTrackingSettings(e)}},{key:"addRecipients",value:function(){var e=new R.mail.Personalization;this.recipients.forEach(function(n){e.addTo(n)}),this.addPersonalization(e)}},{key:"send",value:function(){var e,n=(e=regeneratorRuntime.mark(function e(){var n,t;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return n=this.sgApi.emptyRequest({method:"POST",path:"/v3/mail/send",body:this.toJSON()}),e.next=3,this.sgApi.API(n);case 3:return t=e.sent,e.abrupt("return",t);case 5:case"end":return e.stop()}},e,this)}),function(){var n=this,t=arguments;return new Promise(function(r,o){var i=e.apply(n,t);function u(e){T(i,r,o,u,a,"next",e)}function a(e){T(i,r,o,u,a,"throw",e)}u(void 0)})});return function(){return n.apply(this,arguments)}}()}])&&C(t.prototype,r),o&&C(t,o),n}(),A=function(e){return'\n    <html>\n      <body>\n        <div style="text-align: center;">\n          <h3>I\'d like your input!</h3>\n          <p>Please answer the following question:</p>\n          <p>'.concat(e.body,'</p>\n          <div>\n            <a href="').concat(v.a.redirectDomain,'/api/surveys/thanks">Yes</a>\n          </div>\n          <div>\n            <a href="').concat(v.a.redirectDomain,'/api/surveys/thanks">No</a>\n          </div>\n        </div>\n      </body>\n    </html> \n  ')};function U(e,n,t,r,o,i,u){try{var a=e[i](u),s=a.value}catch(e){return void t(e)}a.done?n(s):Promise.resolve(s).then(r,o)}var G=u.a.model("surveys"),L=function(e){e.get("/api/surveys/thanks",function(e,n){n.send("Thanks for voting!")}),e.post("/api/surveys",k,E,(n=regeneratorRuntime.mark(function e(n,t){var r,o,i,u,a,s,c,l;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return r=n.body,o=r.title,i=r.subject,u=r.body,a=r.recipients,s=new G({title:o,subject:i,body:u,recipients:a.split(",").map(function(e){return{email:e.trim()}}),_user:n.user.id,dateSent:Date.now()}),c=new N(s,A(s)),e.prev=3,e.next=6,c.send();case 6:return e.next=8,s.save();case 8:return n.user.credits-=1,e.next=11,n.user.save();case 11:l=e.sent,t.send(l),e.next=18;break;case 15:e.prev=15,e.t0=e.catch(3),t.status(422).send(e.t0);case 18:case"end":return e.stop()}},e,null,[[3,15]])}),t=function(){var e=this,t=arguments;return new Promise(function(r,o){var i=n.apply(e,t);function u(e){U(i,r,o,u,a,"next",e)}function a(e){U(i,r,o,u,a,"throw",e)}u(void 0)})},function(e,n){return t.apply(this,arguments)}));var n,t};u.a.connect(v.a.mongoURI,{useNewUrlParser:!0},function(e){e&&console.log(e)});var M=o()();M.use(p.a.json()),M.use(s()({maxAge:2592e6,keys:[v.a.cookieKey]})),M.use(l.a.initialize()),M.use(l.a.session()),x(M),P(M),L(M);var Y=t(12).join(__dirname,"../client","build");M.use(o.a.static(Y)),M.get("*",function(e,n){n.sendFile("index.html",{root:Y})});var z=process.env.PORT||5e3;M.listen(z)}]);